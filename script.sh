#!/bin/bash

GREEN='\033[32m'
NC='\0033[0m'

# Install dependances
echo -e "${GREEN}INSTALLATION DES DEPENDANCESS ${NC}"
apt update && apt install wget curl jq -y

# Install TRIVY IF NOT EXIST
echo -e "${GREEN}INSTALLATION DE TRIVY SI NECESSAIRE${NC}"
if [[ ! -e /usr/local/bin/trivy ]]; then
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.20.2
fi

# Install MC IF NOT EXIST
echo -e "${GREEN}INSTALLATION DE MC SI NECESSAIRE${NC}"
if [[ ! -e /usr/local/bin/mc ]]; then
   wget https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mc && chmod 755 /usr/local/bin/mc
fi

# Setup mc alias

`mc alias set minio_home $ENDPOINT_URL $ACCESS_KEY $SECRET_KEY`
`mc ls minio_home`

# Get Service Account Token
TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)

# Get all Namespaces
echo -e "${GREEN}RECUPERATION DES NAMESPACE DU CLUSTER${NC}"
ALL_NAMESPACES=$(curl -s -X GET https://kubernetes.default/api/v1/namespaces \
--header "Authorization: Bearer $TOKEN" --insecure | jq '.items[].metadata.name' -rM)
echo $ALL_NAMESPACES

#Get today's date
today=$(date "+%Y-%m-%d")

# Download Trivy DB
echo -e  "${GREEN}TELECHARGEMENT DE LA BASE DE VULNERABILITES${NC}"
trivy image --download-db-only --no-progress
echo -e "${GREEN}TELECHARGEMENT DE LA BASE TERMINEE${NC}"

#Start Scan
echo -e "${GREEN}DEMARRAGE DU SCAN DES IMAGES PAR NAMESPACE${NC}"
mkdir report_${today} && cd report_${today}
for ns in $ALL_NAMESPACES; do
    echo -e "${GREEN}$ns${NC}"

    report_file="${ns}_${today}.txt"
    touch ${report_file}

    # Get all images in namespace
    images=$(curl -s -X GET https://kubernetes.default/api/v1/namespaces/$ns/pods \
        --header "Authorization: Bearer $TOKEN" --insecure \
        | jq '.items[].spec.containers[].image' -rM | uniq)

    # Scan Image in namespace if necessary
    if [[ -n $images ]]; then 
        for image in $images; do
            echo -e "${GREEN}SCAN DE L'IMAGE ${image}${NC}"
            echo -e  "$image" >> ${report_file}
            trivy --skip-update  $image >> ${report_file}
        done
    else
        echo -e "${GREEN} PAS D'IMAGE DANS LE NAMESPACE ${ns}"
    fi
done

ls -la
cd .. && tar -cvf report_${today}.tar.gz  report_${today}/
mc cp report_${today}.tar.gz minio_home/$BUCKET_NAME